<?php require_once 'config.php'; ?>
<?php
// Check if user is logged in
if (!isset($_SESSION['logged_in']) || !$_SESSION['logged_in']) {
    header('Location: login.php');
    exit();
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // INTENTIONALLY VULNERABLE - Uses username from POST instead of session
    // This allows CSRF attacks to change other users' passwords
    $username = $_POST['username'];
    $new_password = $_POST['new_password'];
    $confirm_password = $_POST['confirm_password'];

    // Check passwords match
    if ($new_password !== $confirm_password) {
        $_SESSION['password_error'] = 'Passwords do not match!';
        header('Location: profile.php');
        exit();
    }

    // INTENTIONALLY VULNERABLE - SQL Injection + no CSRF token
    $query = "UPDATE Users SET password = '$new_password' WHERE username = '$username'";

    if ($conn->query($query)) {
// Check if it was the logged-in user's password that changed
if ($username === $_SESSION['username']) {
$_SESSION['password_success'] = 'Password changed successfully!';
} else {
// CSRF attack succeeded - changed someone else's password
$_SESSION['password_success'] = 'Password changed for user: ' . htmlspecialchars($username);
}
} else {
$_SESSION['password_error'] = 'Failed to change password.';
}

header('Location: profile.php');
exit();
}
?>