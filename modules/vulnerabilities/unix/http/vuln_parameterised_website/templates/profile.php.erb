<% $current_page = 'Profile' -%>
<?php require_once 'config.php'; ?>
<?php
// Check if user is logged in
if (!isset($_SESSION['logged_in']) || !$_SESSION['logged_in']) {
    header('Location: login.php');
    exit();
}

// INTENTIONALLY VULNERABLE - IDOR: Get user ID from URL parameter
$profile_id = isset($_GET['id']) ? $_GET['id'] : $_SESSION['user_id'];

// INTENTIONALLY VULNERABLE - SQL Injection in the ID parameter
$query = "SELECT * FROM Users WHERE ID = $profile_id";
$result = $conn->query($query);

if (!$result || $result->num_rows == 0) {
$_SESSION['error'] = 'User not found!';
header('Location: profile.php?id=' . $_SESSION['user_id']);
exit();
}

$user = $result->fetch_assoc();

// INTENTIONALLY VULNERABLE - Weak access control: only block viewing admin profiles if you're not admin
// Non-admin users can view any other non-admin user's profile
if ($user['admin'] && !$_SESSION['admin']) {
$_SESSION['error'] = 'Access denied! You cannot view administrator profiles.';
header('Location: profile.php?id=' . $_SESSION['user_id']);
exit();
}

// Check if viewing own profile
$is_own_profile = ($profile_id == $_SESSION['user_id']);
?>
<html>
<%= scope.function_template(['vuln_parameterised_website/subtemplates/header.html.erb']) %>
<body>
<%= scope.function_template(['vuln_parameterised_website/subtemplates/navbar.html.erb']) %>
<div id="main_container" class="container">
  <div class="row">
    <div class="col-lg-12">
      <div class="intro-text">
        <h1 class="name"><?php echo $is_own_profile ? 'Your Profile' : htmlspecialchars($user['name']) . "'s Profile"; ?></h1>
        <hr class="star-light">
      </div>
    </div>

    <!-- Display messages -->
    <div class="col-lg-8 col-lg-offset-2">
      <?php
      if (isset($_SESSION['password_success'])) {
          echo '<div class="alert alert-success">' . $_SESSION['password_success'] . '</div>';
    unset($_SESSION['password_success']);
    }
    if (isset($_SESSION['password_error'])) {
    echo '<div class="alert alert-danger">' . $_SESSION['password_error'] . '</div>';
    unset($_SESSION['password_error']);
    }
    if (isset($_SESSION['error'])) {
    echo '<div class="alert alert-danger">' . $_SESSION['error'] . '</div>';
    unset($_SESSION['error']);
    }
    ?>

    <?php if (!$is_own_profile): ?>
    <div class="alert alert-info">
      You are viewing another user's profile.
      <a href="profile.php?id=<?php echo $_SESSION['user_id']; ?>">Return to your profile</a>
    </div>
    <?php endif; ?>
  </div>

  <!-- User Information -->
  <div class="col-lg-6">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3>Account Information</h3>
      </div>
      <div class="panel-body">
        <p><strong>User ID:</strong> <?php echo htmlspecialchars($user['ID']); ?></p>
        <p><strong>Name:</strong> <?php echo htmlspecialchars($user['name']); ?></p>
        <p><strong>Username:</strong> <?php echo htmlspecialchars($user['username']); ?></p>
        <p><strong>Email:</strong> <?php echo htmlspecialchars($user['email']); ?></p>
        <p><strong>Address:</strong> <?php echo htmlspecialchars($user['address']); ?></p>
        <p><strong>Mobile:</strong> <?php echo htmlspecialchars($user['mobile']); ?></p>
        <?php if ($user['admin']): ?>
        <p><strong>Role:</strong> <span class="label label-danger">Administrator</span></p>
        <?php else: ?>
        <p><strong>Role:</strong> <span class="label label-default">User</span></p>
        <?php endif; ?>
      </div>
    </div>
  </div>

  <!-- Change Password Form -->
  <div class="col-lg-6">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3>Change Password</h3>
      </div>
      <div class="panel-body">
        <!-- INTENTIONALLY VULNERABLE - Can change any user's password if you can view their profile -->
        <form method="POST" action="change_password.php">
          <input type="hidden" name="username" value="<?php echo $user['username']; ?>">

          <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" class="form-control" id="new_password" name="new_password" required>
          </div>

          <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
          </div>

          <button type="submit" class="btn btn-primary">
            <?php echo $is_own_profile ? 'Change My Password' : 'Change ' . htmlspecialchars($user['name']) . "'s Password"; ?>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
</div>
<%= scope.function_template(['vuln_parameterised_website/subtemplates/scripts.html.erb']) %>
</body>
</html>