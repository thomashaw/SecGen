class coconut::install {
  $secgen_parameters = secgen_functions::get_parameters($::base64_inputs_file)
  $account = parsejson($secgen_parameters['account'][0])
  $username = $account['username']
  $include_source = str2bool($secgen_parameters['include_source'][0])
  $pack_binary = str2bool($secgen_parameters['pack_binary'][0])

  if $secgen_parameters['flag'] {
    $flag = $secgen_parameters['flag'][0]
  }

  # Generate the C file (either in the home directory or the supplied storage_directory)
  $install_dir = "/home/$username/malware"
  $c_file_path = "$install_dir/coconut.c"

  # Create install dir
  ::secgen_functions::create_directory { "create_$install_dir":
    path => $install_dir,
    notify => File["create $install_dir/coconut.c"],
  }

  # Create C file
  file { "create $install_dir/coconut.c":
    path                    => $c_file_path,
    source                 => 'puppet:///modules/coconut/coconut.c',
    # content                 => template('coconut/coconut.c.erb'),  % TODO: Later
    mode                    => '0777',
  }

  # Compile binary
  exec { "gcc $install_dir/coconut.c":
    cwd     => $install_dir,
    command => "/usr/bin/gcc -o coconut_unpacked coconut.c -lpthread",
    require => File["create $install_dir/coconut.c"],
  }

  if $pack_binary {
    # Pack with upx
    notice("Packing Coconut binary with UPX")
    ensure_packages('upx-ucl')
    exec { "upx $install_dir/coconut":
      cwd     => $install_dir,
      command => "/usr/bin/upx -o coconut coconut_unpacked",
      require => Exec["gcc $install_dir/coconut.c"]
    }
    unless $include_source {
      notice("Removing coconut.c source code file")
      exec { "Removing coconut.c file":
        cwd => $install_dir,
        command => "/bin/rm $install_dir/coconut.c",
        require => Exec["upx $install_dir/coconut"],
      }
    }
  } else {
    notice("No packer used, renaming Coconut binary")
    exec { "rename unpacked binary":
      cwd => $install_dir,
      command => "/bin/mv $install_dir/coconut_unpacked $install_dir/coconut",
    }
    unless $include_source {
      notice("Removing coconut.c source code file")
      exec { "Removing coconut.c file":
        cwd => $install_dir,
        command => "/bin/rm $install_dir/coconut.c",
        require => Exec["rename unpacked binary"]
      }
    }
  }

  # Drop flag
  if $flag and $flag != '' {
    ::secgen_functions::create_directory { "create_infected_dir":
      path => "/home/infected/",
      notify => File["/home/infected/flag"],
      res => "dir-for-$flag",
    }
    file { "/home/infected/flag":
      content => $flag
    }
  }
}
