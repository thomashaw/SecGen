class coconut::install {
  $secgen_parameters = secgen_functions::get_parameters($::base64_inputs_file)
  $account = parsejson($secgen_parameters['account'][0])
  $username = $account['username']

  # Generate the C file (either in the home directory or the supplied storage_directory)
  $install_dir = "/home/$username/malware"
  $c_file_path = "$install_dir/coconut.c"

  # Create install dir
  ::secgen_functions::create_directory { "create_$install_dir":
    path => $install_dir,
    notify => File["create $install_dir/coconut.c"],
  }

  # Create C file
  file { "create $install_dir/coconut.c":
    path                    => $c_file_path,
    source                 => 'puppet:///modules/coconut/coconut.c',
    # content                 => template('coconut/coconut.c.erb'),  % TODO: Later
    mode                    => '0777',
  }

  # Compile binary
  exec { "gcc $install_dir/coconut.c":
    cwd     => $install_dir,
    command => "/usr/bin/gcc -o coconut coconut.c -lpthread",
    require => File["create $install_dir/coconut.c"],
  }


  # Pack with upx
  ensure_packages('upx-ucl')
  # exec { "upx $install_dir/coconut":
  #   cwd     => $install_dir,
  #   command => "/usr/bin/upx TODO",
  #   require => File["create $install_dir/coconut.c"],
  # }

  # Run sample conditionally based on secgen params run_sample parameter-- in service.pp


}
